<app-layout>
  <div header-title><i class="fas fa-car"></i> Registro de Vehículos</div>
  <div header-subtitle>Gestión de vehículos del sistema</div>

  <section class="admin-content">
    <div class="form-section">
      <h2>{{ isEditing ? 'Editar Vehículo' : 'Registrar Nuevo Vehículo' }}</h2>
      <form (ngSubmit)="onSubmit()" #vehicleForm="ngForm">
        <div *ngIf="formError" class="form-banner form-banner--error"
          style="margin-bottom: 1rem; padding: 1rem; background: #fee2e2; color: #991b1b; border-radius: 8px;">
          <i class="fas fa-exclamation-triangle"></i> {{ formError }}
        </div>
        <div *ngIf="formSuccess" class="form-banner form-banner--success"
          style="margin-bottom: 1rem; padding: 1rem; background: #d1fae5; color: #065f46; border-radius: 8px;">
          <i class="fas fa-check-circle"></i> {{ formSuccess }}
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="matricula">Matrícula</label>
            <input type="text" id="matricula" name="matricula" [(ngModel)]="newVehicle.matricula" required
              placeholder="Ej: B123456">
          </div>
          <div class="form-group">
            <label for="marca">Marca</label>
            <input type="text" id="marca" name="marca" [(ngModel)]="newVehicle.marca" required placeholder="Ej: BYD">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="modelo">Modelo</label>
            <input type="text" id="modelo" name="modelo" [(ngModel)]="newVehicle.modelo" required placeholder="Ej: E2">
          </div>
          <div class="form-group">
            <label for="tipo">Tipo de Batería</label>
            <select id="tipo" name="tipo" [(ngModel)]="newVehicle.tipo" required>
              <option value="" disabled selected>Selecciona una opción</option>
              <option value="Ion-Litio (Li-ion)">Ion-Litio (Li-ion)</option>
              <option value="Fosfato de Hierro y Litio (LFP)">Fosfato de Hierro y Litio (LFP)</option>
              <option value="Níquel-Manganeso-Cobalto (NMC)">Níquel-Manganeso-Cobalto (NMC)</option>
              <option value="Estado Sólido">Estado Sólido</option>
              <option value="Polímero de Litio (LiPo)">Polímero de Litio (LiPo)</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <div class="button-group" style="display: flex; gap: 1rem;">
              <button type="submit" class="btn-submit">
                {{ isEditing ? 'Guardar Cambios' : 'Registrar Vehículo' }}
              </button>
              <button type="button" class="btn-delete" style="background: #64748b; color: white; border-color: #64748b;"
                *ngIf="isEditing" (click)="cancelEdit()">
                <i class="fas fa-times"></i> Cancelar Edición
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div class="table-section">
      <h2>Vehículos Registrados</h2>
      <table class="vehicles-table">
        <thead>
          <tr>
            <th>Matrícula</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Tipo de Batería</th>
            <th>Estado</th>
            <th>Conductor asignado</th>
            <th>Asignar conductor</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let vehicle of vehicles">
            <td>{{ vehicle.matricula }}</td>
            <td>{{ vehicle.marca }}</td>
            <td>{{ vehicle.modelo }}</td>
            <td>{{ vehicle.tipo }}</td>
            <td><span class="vehicle-status active">{{ vehicle.estado }}</span></td>
            <td>
              <div class="assign-card__current">
                <span class="assign-card__current-label">Conductor activo</span>
                <div class="assign-card__current-value">
                  <i class="fas fa-id-badge"></i>
                  <span>{{ getDriverLabel(vehicle) }}</span>
                </div>
              </div>
            </td>
            <td>
              <div class="assign-card">
                <div class="assign-card__info">
                  <span class="assign-card__badge">
                    <i class="fas fa-random"></i>
                    Cambio rápido
                  </span>
                  <p>Selecciona o reemplaza al conductor de este vehículo.</p>
                </div>
                <div class="assign-card__control">
                  <label class="assign-card__label">Nuevo conductor</label>
                  <select class="assign-card__select" [ngModel]="vehicle.conductorId ?? ''"
                    (ngModelChange)="assignDriver(vehicle, $event)" [ngModelOptions]="{ standalone: true }"
                    aria-label="Asignar conductor al vehículo">
                    <option value="">Sin conductor</option>
                    <option *ngFor="let driver of drivers" [value]="driver.id">
                      {{ driver.nombreCompleto }} · CI {{ driver.ci }}
                    </option>
                  </select>
                </div>
              </div>
            </td>
            <td>
              <div class="table-actions">
                <button class="btn-view" (click)="viewVehicle(vehicle)">
                  <i class="fas fa-eye"></i>
                  Visualizar
                </button>
                <button class="btn-edit" (click)="editVehicle(vehicle)">
                  <span class="material-icons">edit</span>
                  Editar
                </button>
                <button class="btn-delete" (click)="deleteVehicle(vehicle)">
                  <span class="material-icons">delete</span>
                  Eliminar
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</app-layout>